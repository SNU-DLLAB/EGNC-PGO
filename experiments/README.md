# Experimental Validation

This folder contains scripts, data and results used for experimental validation of EGNC-PGO, riSAM and relative prior works.
This file provides general documentation on the process, file formats, and how to use. 

# Directory Structure
* `dataset`: Contains benchmark SLAM datasets in g2o/toro format
* `exp_runner`: Implements wrappers around all methods so that they all provide a standard interface
* `scripts`: Contains a number of useful pythons scripts for manipulating datasets, evaluating results, and visualizing
* `thirdparty`: Contains thirdparty code that implements prior works
* `run-experiment.cpp`: Main entry point for running a method implemented in `exp_runner` on an IRL dataset (For details on IRL datasets see `experiments/irl/README.md`).

Each subdirectory contains its own README with relevant information.

# Experiment Runner
The executable `run-experiment` is the main entry point to running EGNC-PGO, riSAM and prior works. Its arguments are as follows:
* `irl_file`, `i`: Path to Incremental Robot Log file. (see `experiments/irl/README.md`)
* `method`, `m`: The name of the method to run (e.g. pseudo-gt, see `exp_runners/include/Factory.h` for more options).
* `save_every_n`, `n`: Runner will save intermediate result files every N iterations.
* `output_dir`, `o`: Directory to which the results will be saved.
* `mode`, `d`: Mode to run (only works with risam method. For the others, it doesn't work but required.). 0: original risam, 3: EGNC-PGO (1: B-spline without adaptive, 2: adaptive, from AGNC-PGO)

All options are required. This script will produce an output whos contents are specified in the next section. 

## Experiment Runner Quirks
The Experiment Runner interface was originally written to support generic multi-modal measurements, rather than just instances of robust-SLAM problems where we have at most two modes (some measurement and the Null Hypothesis). However, not all of the method implementations are written this generically. All method implementations are guaranteed to work for IRL files (see `experiments/irl/README.md`) that contain, single modal priors, single modal odometry, and loop-closure measurements with two modes, a measurement and a Null Hypothesis mode. If you use the scripts in `scripts` to generate datasets you should be all set to use this interface.

# Quick Start Guide
The following is an example work-flow to play with EGNC-PGO and the prior works included in this repo. In this we assume the working directory is `experiments`

### 1. Corrupt a Gridworld dataset
* First lets make a directory to store all of our data and results. 
    * `mkdir ~/<some-path>/EGNC-PGO_test_environment`
    * `mkdir ~/<some-path>/EGNC-PGO_test_environment/datasets`
* Next lets corrupt a 2d dataset with outliers and convert to IRL format using the `g2o-2-irl` script
    * `./scripts/g2o-2-irl -i datasets/csail/csail.g2o -n CSAIL -o ~/<some-path>/EGNC-PGO_test_environment/datasets/ --add_outliers --outlier_percentiles 10 --outlier_covariance 0.015 0.01 0.001 --outlier_chi2_thresh 0.95`
    * `-i` is the input dataset, in this case CSAIL
    * `-o` is the output directory for the datasets generated by the script
    * `--add_outliers` Flags that we are adding outliers while converting the dataset
    * `--outlier_percentiles` Are the percentiles of total loop closures that outliers should make up. If multiple are given the script generates multiple datasets. 
    * `--outlier_covariance` specifies the noise model for outlier loop-closures and the value above is approximately the  average loop-closure noise model from the CSAIL dataset. For other datasets, a model should be used to match the dataset.
    * `--outlier_chi2_thresh` specifies the chi-squared value that an outlier must have relative to the un-corrupted solution.
    * For more options run the script with `--help`

* You should now see `~/<some-path>/EGNC-PGO_test_environment/datasets/10` that contains one CSAIL dataset with 10% outliers.

### 2. Run EGNC-PGO on the dataset
* First lets make a directory to store the results
    * `mkdir ~/<some-path>/EGNC-PGO_test_environment/results`
* Now lets run EGNC-PGO
    * `../build/experiments/run-experiment -i ~/<some-path>/EGNC-PGO_test_environment/datasets/10/CSAIL_10_random_0.irl -o ~/<some-path>/EGNC-PGO_test_environment/results/ -m risam -n 1 -d 3`
* We should now see a directory in results like `results/CSAIL_10_random_0_risam_YYYY-MM-DD_HH-MM-SS`
* You can run prior works bu changing the `-m` ("method") option
* You can run riSAM by using `-m risam -d 0` option
* You can run AGNC-PGO by using `-m risam -d 1`, or `-m risam -d 2` option
* You can run EGNC-PGO by using `-m risam -d 3` option

### 3. Plot our results
* Lets visualize the results
    * `./scripts/plot-traj -i ~/<some-path>/EGNC-PGO_test_environment/datasets/10/CSAIL_10_random_0.irl -r ~/<some-path>/EGNC-PGO_test_environment/results/CSAIL_10_random_0_risam_2023-03-09_14-28-37/ --legend`
* You should see a plot of the final solution and print outs of the trajectory.
* Further, lets animate the trajectory so we can see all the incremental steps
    * `./scripts/animate-traj -i ~/<some-path>/EGNC-PGO_test_environment/datasets/10/CSAIL_10_random_0.irl -r ~/<some-path>/EGNC-PGO_test_environment/results/CSAIL_10_random_0_risam_2023-03-09_14-28-37/iterations/`

# Prior Works

Each entry the name is followed by common abbreviation then "Method Name" as defined in `exp_runner/include/exp_runner/Factor.h`

### riSAM 
'''
McGann, Daniel, John G. Rogers, and Michael Kaess. "Robust Incremental
 Smoothing and Mapping (riSAM)." In 2023 IEEE International Conference 
 on Robotics and Automation (ICRA), pp. 4157-4163. IEEE, 2023.
'''
Implementation provided with mode 0

### Graduated Non-Convexity (GNC, gnc-batch)
```
H. Yang, P. Antonante, V. Tzoumas, and L. Carlone, “Graduated non-
convexity for robust spatial perception: From non-minimal solvers to
global outlier rejection,” IEEE Robotics and Automation Letters (RA-
L), vol. 5, no. 2, pp. 1127–1134, 2020.
```
Implementation provided in GTSAM

### Pairwise Consistency Maximization (PCM, pcm)
Note: different method names correspond to different hyper-parameters.
```
J. Mangelson, D. Dominic, R. Eustice, and R. Vasudevan, “Pairwise
consistent measurement set maximization for robust multi-robot map
merging,” in Proc. IEEE Intl. Conf. on Robotics and Automation
(ICRA), Brisbane, AU, 2018, pp. 2916–2923.
```
Implementation provided in KimeraRPGO (`thirdparty/Kimera-RPGO`)

### MaxMixture (MaxMix, maxmix)
```
E. Olson and P. Agarwal, “Inference on networks of mixtures for robust
robot mapping,” Intl. J. of Robotics Research (IJRR), vol. 32, no. 7,
pp. 826–840, 2013.
```
Implementation internal.

### MEstimator (MEst, method name dependent on the M-Estimator used)
```
Z. Zhang, “Parameter estimation techniques: a tutorial with application
to conic fitting,” Image and Vision Computing, vol. 15, no. 1, pp. 59–
76, 1997.
```
Implementation baked into GTSAM.

### Discrete Continuous Smoothing and Mapping (DC-SAM, dcsam)
```
K. Doherty, Z. Lu, K. Singh, and J. Leonard, “Discrete-continuous
smoothing and mapping,” arXiv preprint arXiv:2204.11936v2 [cs],
2022
```
Implementation provided by DC-SAM (`thirdparty/dcsam`)


### Adaptive Graduated Non-Convexity for Pose Graph Optimization (AGNC-PGO)
'''
Choi, Seungwon, Wonseok Kang, Jiseong Chung, Jaehyun Kim, and Tae-wan Kim. "Adaptive Graduated Non-Convexity for Pose Graph Optimization." arXiv preprint arXiv:2308.11444 (2023).
'''
Our prior work. Provided with mode 1, 2